<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LatRen — LaTeX → Image (PNG/SVG)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0d12;         /* dark base */
      --panel: #121623;      /* panels */
      --panel-2: #0e1320;    /* header/footer */
      --text: #e6ecff;       /* main text */
      --muted: #a1accf;      /* muted text */
      --accent: #7aa2ff;     /* primary accent */
      --accent-2: #00d4ff;   /* secondary accent */
      --success: #6be675;
      --danger: #ff7a84;
      --warning: #ffb454;
      --border: #232a46;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .light{
      --bg: #f7f8fb;
      --panel: #ffffff;
      --panel-2: #f3f6ff;
      --text: #111525;
      --muted: #4b5578;
      --accent: #305eff;
      --accent-2: #00a3c4;
      --success: #229954;
      --danger: #cb2b3e;
      --warning: #d18609;
      --border: #dfe6fb;
      --shadow: 0 10px 30px rgba(24, 35, 75, .12);
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.45; letter-spacing:.2px;
    }
    .container{max-width:1200px; margin:0 auto; padding:24px;}
    header{
      background:linear-gradient(135deg, var(--panel-2), transparent 60%), linear-gradient(45deg, rgba(48,94,255,.15), rgba(0,212,255,.05));
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
    }
    .hdr-inner{display:flex; align-items:center; justify-content:space-between; gap:16px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{width:40px; height:40px; border-radius:12px; background:radial-gradient(120px 50px at 30% 30%, var(--accent), transparent 70%), radial-gradient(120px 50px at 70% 70%, var(--accent-2), transparent 70%), linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0)); box-shadow:var(--shadow);}
    .title{font-weight:800; font-size:20px; letter-spacing:0.5px}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted);}
    .toolbar{display:flex; gap:10px; align-items:center}
    .switch{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    .switch input{appearance:none; width:44px; height:26px; background:var(--panel); border:1px solid var(--border); border-radius:999px; position:relative; outline:none; cursor:pointer; transition:.2s}
    .switch input:checked{background:linear-gradient(45deg, var(--accent), var(--accent-2))}
    .switch input::after{content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:.2s}
    .switch input:checked::after{left:21px}

    main{padding-top:18px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}

    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
    .panel h2{margin:0; padding:14px 16px; font-size:14px; letter-spacing:.5px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border)}
    .panel .body{padding:16px}

    textarea{
      width:100%; min-height:260px; resize:vertical; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); color:var(--text);
      font: 14px/1.5 "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      padding:14px; outline:none; box-shadow: inset 0 0 0 999px rgba(0,0,0,0);
    }
    textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(122,162,255,.25)}

    .controls{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .controls .group{display:flex; align-items:center; gap:8px; background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:8px 10px}
    .controls .group label{font-size:12px; color:var(--muted)}
    input[type="number"], input[type="text"], select{background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text); padding:6px 8px; outline:none}
    input[type="color"]{appearance:none; border:none; background:transparent; width:28px; height:28px}
    .btn{
      appearance:none; border:none; background:linear-gradient(45deg, var(--accent), var(--accent-2)); color:white; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:var(--shadow);
      transition:transform .08s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid var(--border)}
    .btn.warn{background:linear-gradient(45deg, var(--warning), #ffda8a)}
    .btn.good{background:linear-gradient(45deg, var(--success), #9ef7a7)}
    .btn.bad{background:linear-gradient(45deg, var(--danger), #ffb1b7)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}

    .preview-wrap{padding:16px}
    .canvas-wrap{display:flex; align-items:center; justify-content:center; min-height:260px; background: repeating-conic-gradient(#0000 0 25%, rgba(127,127,127,.1) 0 50%) 50% / 16px 16px; border:1px dashed var(--border); border-radius:12px}
    .preview{max-width:100%; height:auto; display:block}
    .meta{display:flex; gap:12px; flex-wrap:wrap; color:var(--muted); font-size:13px; margin-top:8px}

    details.instructions{margin-top:14px; background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:12px 14px}
    details.instructions summary{cursor:pointer; font-weight:600}
    details.instructions p{color:var(--muted); margin:.4em 0}

    .templates{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .template{font-size:12px; padding:6px 8px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); cursor:pointer}

    .status{margin-top:10px; font-size:13px}
    .status.ok{color:var(--success)}
    .status.err{color:var(--danger); white-space:pre-wrap}

    .history{display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:12px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column}
    .card img{width:100%; height:160px; object-fit:contain; background: #0a0a0a10}
    .card .info{padding:10px}
    .card .info small{color:var(--muted)}
    .card .actions{display:flex; gap:8px; padding:10px}

    footer{margin-top:32px; padding:18px 0; color:var(--muted); border-top:1px solid var(--border)}
    code.inline{font-family:"JetBrains Mono", monospace; background:rgba(122,162,255,.12); padding:.2em .45em; border-radius:6px}

    /* Responsive */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
  </style>
  <!-- MathJax (TeX → SVG). If you need offline use, download and host locally later. -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [["$","$"],["\\(","\\)"]],
        displayMath: [["$$","$$"],["\\[","\\]"]],
        packages: {'[+]': ['base', 'ams']},
        maxBuffer: 10_000
      },
      svg: { fontCache: 'none' },
      options: { enableMenu: false }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body class="light" id="body">
  <header>
    <div class="container hdr-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">LatRen</div>
          <div class="badge">Standalone LaTeX → Image Toolkit</div>
        </div>
      </div>
      <div class="toolbar">
        <label class="switch" title="Toggle theme">
          <input id="themeToggle" type="checkbox" />
          <span>Dark mode</span>
        </label>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Editor Panel -->
      <section class="panel" aria-labelledby="editor-title">
        <h2 id="editor-title">Editor</h2>
        <div class="body">
          <div class="row">
            <div>
              <label for="latex" class="badge">LaTeX Input</label>
              <textarea id="latex" spellcheck="false" placeholder="Type LaTeX here...">\\begin{aligned}
L^{(k)} \\;=\\; \frac{1}{m} \sum_{i=1}^{m} \left( \\hat{y}^{(i)} - y^{(i)} \right)^2 \\quad\text{with}\\quad \\hat{y}^{(i)} = f_\\theta(x^{(i)})
\\end{aligned}
</textarea>
            </div>
          </div>

          <div class="templates">
            <button class="template" data-snippet="\int_{-\infty}^{\infty} e^{-x^2} \; dx = \sqrt{\pi}">Integral</button>
            <button class="template" data-snippet="\mathbf{A}=\begin{bmatrix}a&b\\c&d\end{bmatrix},\;\det(\mathbf{A}) = ad-bc">Matrix</button>
            <button class="template" data-snippet="\begin{cases} f(x)=x^2, & x\ge 0\\ f(x)=-x, & x<0 \end{cases}">Piecewise</button>
            <button class="template" data-snippet="\nabla J(\theta)=\left[\frac{\partial J}{\partial \theta_1},\dots,\frac{\partial J}{\partial \theta_n}\right]">Gradient</button>
            <button class="template" data-snippet="\sum_{k=0}^{n} r^k = \frac{1-r^{n+1}}{1-r},\; r\ne 1">Series</button>
            <button class="template" data-snippet="\hat{y}(x) = \sum_{j=0}^p w_j x^j + b">Polynomial fit</button>
            <button class="template" data-snippet="x^2">x²</button>
            <button class="template" data-snippet="x^{n}">x^n</button>
            <button class="template" data-snippet="x_{i}">x_i</button>
            <button class="template" data-snippet="\frac{a}{b}">Fraction</button>
            <button class="template" data-snippet="\sqrt{x}">√x</button>
            <button class="template" data-snippet="\sqrt[n]{x}">n√x</button>
            <button class="template" data-snippet="\lvert x \rvert">|x|</button>
            <button class="template" data-snippet="\lVert \mathbf{x} \rVert">‖x‖</button>
            <button class="template" data-snippet="\lfloor x \rfloor">⌊x⌋</button>
            <button class="template" data-snippet="\lceil x \rceil">⌈x⌉</button>
            <button class="template" data-snippet="\overline{AB}">Overline</button>
            <button class="template" data-snippet="\vec{v}">→v</button>
            <button class="template" data-snippet="\hat{y}">ŷ</button>
            <button class="template" data-snippet="\bar{x}">\bar{x}</button>
            <button class="template" data-snippet="\dot{x}">\dot{x}</button>
            <button class="template" data-snippet="\ddot{x}">\ddot{x}</button>
            <button class="template" data-snippet="f(x)=">f(x)=</button>
            <button class="template" data-snippet="( \, )">( )</button>
            <button class="template" data-snippet="[ \, ]">[ ]</button>
            <button class="template" data-snippet="\{ \, \}">{ }</button>
          </div>

          <div class="controls" aria-label="Render and export controls">
            <button class="btn" id="renderBtn">Render (Ctrl/⌘+Enter)</button>
            <button class="btn secondary" id="liveToggle" aria-pressed="false">Live: Off</button>
            <button class="btn good" id="downloadPNGBtn">Download PNG (Ctrl/⌘+S)</button>
            <button class="btn secondary" id="downloadSVGBtn">Download SVG</button>
            <button class="btn secondary" id="copyPNGBtn">Copy PNG</button>
            <button class="btn secondary" id="copySVGBtn">Copy SVG</button>
            <button class="btn secondary" id="shareBtn">Share link</button>
            <button class="btn warn" id="saveHistoryBtn">Save to History</button>
            <button class="btn bad" id="clearBtn">Clear</button>
          </div>

          <div class="controls" aria-label="Output options">
            <div class="group"><label for="scale">Scale</label><input id="scale" type="number" min="0.25" step="0.25" value="2" />×</div>
            <div class="group"><label for="padding">Padding</label><input id="padding" type="number" min="0" step="2" value="20" /> px</div>
            <div class="group"><label for="bg">Background</label><input id="bg" type="color" value="#ffffff" title="Background color"/><label><input id="transparent" type="checkbox" /> transparent</label></div>
            <div class="group"><label><input id="watermarkToggle" type="checkbox"/> watermark</label><input id="watermarkText" type="text" value="LatRen" title="Watermark text"/></div>
          </div>

          <div class="status" id="status"></div>

          <details class="instructions">
            <summary>How to use</summary>
            <p>Type math LaTeX (e.g., environments like <code class="inline">aligned</code>, <code class="inline">cases</code>, <code class="inline">bmatrix</code>). Use <code class="inline">$$...$$</code> or block environments — full documents with <code class="inline">\\documentclass</code> are <em>not</em> supported.</p>
            <p>Click <strong>Render</strong>, then <strong>Download PNG/SVG</strong>. Adjust <em>scale</em> for resolution and <em>padding</em> for margins. Toggle <em>transparent</em> background for overlays. Use <strong>Share link</strong> to encode your formula in the URL.</p>
            <p>Shortcuts: <code class="inline">Ctrl/⌘+Enter</code> render · <code class="inline">Ctrl/⌘+S</code> download PNG · <code class="inline">Ctrl/⌘+K</code> copy PNG</p>
          </details>
        </div>
      </section>

      <!-- Preview Panel -->
      <section class="panel" aria-labelledby="preview-title">
        <h2 id="preview-title">Preview</h2>
        <div class="preview-wrap">
          <div class="canvas-wrap">
            <img id="preview" alt="Rendered LaTeX preview" class="preview" />
          </div>
          <div class="meta">
            <div id="meta-size">—</div>
            <div id="meta-type">PNG</div>
            <div id="meta-bg">BG: #FFFFFF</div>
          </div>
        </div>
      </section>
    </div>

    <!-- History Panel -->
    <section class="panel" style="margin-top:18px" aria-labelledby="history-title">
      <h2 id="history-title">History (local)</h2>
      <div class="body">
        <div class="history" id="history"></div>
      </div>
    </section>

    <footer>
      <div>
        Built with MathJax (TeX→SVG), client-side PNG conversion, and localStorage. Fully standalone single-file app. Ideal for demonstrating algorithms (parsing, rendering pipeline, data URL handling, clipboard API) in an IB CS IA.
      </div>
    </footer>
  </main>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const els = {
      body: document.getElementById('body'),
      latex: $('#latex'),
      renderBtn: $('#renderBtn'),
      liveToggle: $('#liveToggle'),
      preview: $('#preview'),
      status: $('#status'),
      metaSize: $('#meta-size'),
      metaType: $('#meta-type'),
      metaBg: $('#meta-bg'),
      scale: $('#scale'),
      padding: $('#padding'),
      bg: $('#bg'),
      transparent: $('#transparent'),
      downloadPNGBtn: $('#downloadPNGBtn'),
      downloadSVGBtn: $('#downloadSVGBtn'),
      copyPNGBtn: $('#copyPNGBtn'),
      copySVGBtn: $('#copySVGBtn'),
      clearBtn: $('#clearBtn'),
      shareBtn: $('#shareBtn'),
      saveHistoryBtn: $('#saveHistoryBtn'),
      history: $('#history'),
      themeToggle: $('#themeToggle'),
      watermarkToggle: $('#watermarkToggle'),
      watermarkText: $('#watermarkText'),
    };

    const state = {
      svgText: '',
      pngDataURL: '',
      pngBlob: null,
      live: false,
      dark: false,
    };

    // Theme
    els.themeToggle.addEventListener('change', () => {
      state.dark = els.themeToggle.checked;
      document.body.classList.toggle('light', !state.dark);
      document.body.classList.toggle('dark', state.dark);
    });

    // Templates insertion
    $$('.template').forEach(btn => btn.addEventListener('click', () => {
      const t = btn.getAttribute('data-snippet');
      insertAtCursor(els.latex, t);
      if(state.live) render();
    }));

    function insertAtCursor(textarea, text){
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const value = textarea.value;
      textarea.value = value.slice(0,start) + text + value.slice(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
    }

    // Live toggle
    els.liveToggle.addEventListener('click', () => {
      state.live = !state.live;
      els.liveToggle.setAttribute('aria-pressed', String(state.live));
      els.liveToggle.textContent = `Live: ${state.live ? 'On' : 'Off'}`;
      if(state.live) render();
    });

    // Status helpers
    function setStatus(msg, ok=false){
      els.status.textContent = msg;
      els.status.className = 'status ' + (ok ? 'ok' : 'err');
    }
    function clearStatus(){
      els.status.textContent = '';
      els.status.className = 'status';
    }

    // Render flow: TeX -> SVG (MathJax) -> PNG (Canvas)
    async function render(){
      clearStatus();
      const tex = els.latex.value.trim();
      if(!tex){ setStatus('Enter some LaTeX to render.'); return; }

      // Wait for MathJax startup if needed
      if(window.MathJax && MathJax.startup && MathJax.startup.promise){
        await MathJax.startup.promise;
      }

      let svgNode;
      try {
        svgNode = await MathJax.tex2svgPromise(tex, {display: true});
      } catch (err) {
        console.error(err);
        setStatus('LaTeX error: ' + (err.message || err.toString()));
        return;
      }

      const svg = svgNode.querySelector('svg');
      if(!svg){
        setStatus('Failed to create SVG.');
        return;
      }
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.removeAttribute('style'); // ensure clean

      // Optional watermark
      if(els.watermarkToggle.checked){
        const txt = (els.watermarkText.value || 'LatRen').slice(0,64);
        const vb = (svg.getAttribute('viewBox') || '0 0 100 100').split(/\s+/).map(Number);
        const [vx, vy, vw, vh] = vb.length===4? vb : [0,0,100,100];
        const wm = document.createElementNS('http://www.w3.org/2000/svg','text');
        wm.setAttribute('x', String(vx + vw - 4));
        wm.setAttribute('y', String(vy + vh - 4));
        wm.setAttribute('text-anchor','end');
        wm.setAttribute('fill', 'rgba(127,127,127,0.35)');
        wm.setAttribute('font-size', String(Math.max(8, Math.min(16, vw*0.04))));
        wm.textContent = txt;
        svg.appendChild(wm);
      }

      // Serialize SVG
      const ser = new XMLSerializer();
      let svgText = ser.serializeToString(svg);
      // Add XML header for better compatibility
      if(!svgText.startsWith('<?xml')){
        svgText = `<?xml version="1.0" encoding="UTF-8"?>\n` + svgText;
      }
      state.svgText = svgText;

      // Convert SVG -> PNG
      try {
        const scale = clamp(parseFloat(els.scale.value)||1, 0.1, 8);
        const padding = Math.max(0, parseInt(els.padding.value||0,10));
        const transparent = els.transparent.checked;
        const bg = transparent ? 'transparent' : els.bg.value;
        const png = await svgToPng(svgText, scale, bg, padding);
        els.preview.src = png.dataURL;
        state.pngDataURL = png.dataURL;
        state.pngBlob = png.blob;

        // Meta info
        els.metaSize.textContent = `${png.canvas.width} × ${png.canvas.height}px`;
        els.metaType.textContent = 'PNG';
        els.metaBg.textContent = `BG: ${transparent ? 'transparent' : els.bg.value.toUpperCase()}`;

      } catch (err) {
        console.error(err);
        setStatus('Render error: ' + (err.message || err.toString()));
        return;
      }

      setStatus('Rendered successfully ✓', true);
      saveDraft();
    }

    function clamp(v, mn, mx){ return Math.max(mn, Math.min(mx, v)); }

    function svgToPng(svgText, scale, bgColor, padding){
      return new Promise((resolve, reject) => {
        const img = new Image();
        const blob = new Blob([svgText], {type:'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        img.onload = () => {
          // Compute canvas size
          const w = Math.ceil(img.width * scale + 2*padding);
          const h = Math.ceil(img.height * scale + 2*padding);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          if(bgColor !== 'transparent'){
            ctx.fillStyle = bgColor;
            ctx.fillRect(0,0,w,h);
          }
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, padding, padding, img.width * scale, img.height * scale);

          canvas.toBlob(b => {
            URL.revokeObjectURL(url);
            if(!b) return reject(new Error('Failed to create PNG blob'));
            resolve({blob: b, dataURL: URL.createObjectURL(b), canvas});
          }, 'image/png');
        };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    // Downloads & clipboard
    function download(name, blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = name; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    els.downloadPNGBtn.addEventListener('click', async () => {
      if(!state.pngBlob) await render();
      const name = suggestName('latren', 'png');
      download(name, state.pngBlob);
    });

    els.downloadSVGBtn.addEventListener('click', () => {
      if(!state.svgText){ setStatus('Nothing to download. Render first.'); return; }
      const blob = new Blob([state.svgText], {type:'image/svg+xml'});
      download(suggestName('latren','svg'), blob);
    });

    els.copyPNGBtn.addEventListener('click', async () => {
      try{
        if(!state.pngBlob) await render();
        await navigator.clipboard.write([ new ClipboardItem({ 'image/png': state.pngBlob }) ]);
        setStatus('PNG copied to clipboard ✓', true);
      }catch(err){ setStatus('Clipboard not available: ' + err, false); }
    });

    els.copySVGBtn.addEventListener('click', async () => {
      try{
        if(!state.svgText) await render();
        const type = 'image/svg+xml';
        const blob = new Blob([state.svgText], {type});
        await navigator.clipboard.write([ new ClipboardItem({ [type]: blob }) ]);
        setStatus('SVG copied to clipboard ✓', true);
      }catch(err){ setStatus('Clipboard not available: ' + err, false); }
    });

    // Share link (encode LaTeX & options in URL hash)
    els.shareBtn.addEventListener('click', () => {
      const url = buildShareUrl();
      navigator.clipboard.writeText(url).then(() => setStatus('Sharable link copied ✓', true));
      history.replaceState(null, '', url);
    });

    function buildShareUrl(){
      const o = new URL(location.href);
      const params = new URLSearchParams();
      params.set('q', b64enc(els.latex.value));
      params.set('s', String(els.scale.value));
      params.set('p', String(els.padding.value));
      params.set('t', els.transparent.checked ? '1' : '0');
      return `${o.origin}${o.pathname}#${params.toString()}`;
    }

    function parseShareUrl(){
      if(!location.hash) return;
      const qs = location.hash.slice(1);
      const params = new URLSearchParams(qs);
      if(params.has('q')){
        try{ els.latex.value = b64dec(params.get('q')||''); }catch{}
      }
      if(params.has('s')) els.scale.value = params.get('s');
      if(params.has('p')) els.padding.value = params.get('p');
      if(params.has('t')) els.transparent.checked = params.get('t')==='1';
    }

    function b64enc(str){ return btoa(unescape(encodeURIComponent(str))); }
    function b64dec(str){ return decodeURIComponent(escape(atob(str))); }

    function suggestName(base, ext){
      const t = new Date().toISOString().replace(/[:.]/g,'-');
      return `${base}-${t}.${ext}`;
    }

    // History (localStorage)
    const HISTORY_KEY = 'latren-history-v1';

    function loadHistory(){
      try{
        const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }

    function saveHistoryCard(item){
      const card = document.createElement('div');
      card.className = 'card';
      const img = document.createElement('img');
      img.src = item.pngURL; img.alt = 'Formula preview';
      const info = document.createElement('div'); info.className='info';
      const small = document.createElement('small');
      small.textContent = new Date(item.time).toLocaleString();
      info.appendChild(small);
      const actions = document.createElement('div'); actions.className='actions';
      const btnUse = document.createElement('button'); btnUse.className='btn secondary'; btnUse.textContent='Load';
      const btnDL = document.createElement('button'); btnDL.className='btn'; btnDL.textContent='PNG';
      btnUse.onclick = () => { els.latex.value = item.latex; if(state.live) render(); window.scrollTo({top:0, behavior:'smooth'}); };
      btnDL.onclick = () => fetch(item.pngURL).then(r=>r.blob()).then(b=>download(suggestName('latren','png'), b));
      actions.appendChild(btnUse); actions.appendChild(btnDL);
      card.appendChild(img); card.appendChild(info); card.appendChild(actions);
      els.history.prepend(card);
    }

    function refreshHistory(){
      els.history.innerHTML = '';
      loadHistory().forEach(saveHistoryCard);
    }

    function addToHistory(){
      if(!state.pngDataURL) { setStatus('Render first to save history.'); return; }
      const items = loadHistory();
      const entry = { latex: els.latex.value, pngURL: state.pngDataURL, time: Date.now() };
      items.unshift(entry);
      while(items.length > 24) items.pop();
      localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
      saveHistoryCard(entry);
      setStatus('Saved to history ✓', true);
    }

    els.saveHistoryBtn.addEventListener('click', addToHistory);

    // Draft persistence
    const DRAFT_KEY = 'latren-draft-v1';
    function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify({
      latex: els.latex.value, scale: els.scale.value, padding: els.padding.value,
      bg: els.bg.value, transparent: els.transparent.checked,
    })); }
    function loadDraft(){ try{
      const d = JSON.parse(localStorage.getItem(DRAFT_KEY)||'null');
      if(d){ els.latex.value = d.latex||els.latex.value; els.scale.value = d.scale||els.scale.value; els.padding.value = d.padding||els.padding.value; els.bg.value = d.bg||els.bg.value; els.transparent.checked = !!d.transparent; }
    }catch{} }

    // Clear
    els.clearBtn.addEventListener('click', () => {
      els.latex.value=''; state.svgText=''; state.pngDataURL=''; state.pngBlob=null; els.preview.removeAttribute('src'); els.metaSize.textContent='—'; clearStatus(); saveDraft();
    });

    // Rerender when options change (if live)
    ['input','change'].forEach(ev => {
      [els.latex, els.scale, els.padding, els.bg, els.transparent, els.watermarkToggle, els.watermarkText].forEach(el => {
        el.addEventListener(ev, () => { saveDraft(); if(state.live) render(); });
      });
    });

    // Buttons
    els.renderBtn.addEventListener('click', render);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); render(); }
      if((e.ctrlKey||e.metaKey) && (e.key==='s' || e.key==='S')){ e.preventDefault(); els.downloadPNGBtn.click(); }
      if((e.ctrlKey||e.metaKey) && (e.key==='k' || e.key==='K')){ e.preventDefault(); els.copyPNGBtn.click(); }
    });

    // Init on load
    loadDraft();
    parseShareUrl();
    refreshHistory();
    setTimeout(render, 50); // initial render
  })();
  </script>
</body>
</html>
