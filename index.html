<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LatRen — LaTeX → Image (PNG/SVG)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <!-- JSZip for Batch → ZIP (client-side only) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{
      --bg: #0b0d12;
      --panel: #121623;
      --panel-2: #0e1320;
      --text: #e6ecff;
      --muted: #a1accf;
      --accent: #7aa2ff;
      --accent-2: #00d4ff;
      --success: #6be675;
      --danger: #ff7a84;
      --warning: #ffb454;
      --border: #232a46;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --popover: #0c1020;
    }
    .light{
      --bg: #f7f8fb;
      --panel: #ffffff;
      --panel-2: #f3f6ff;
      --text: #111525;
      --muted: #4b5578;
      --accent: #305eff;
      --accent-2: #00a3c4;
      --success: #229954;
      --danger: #cb2b3e;
      --warning: #d18609;
      --border: #dfe6fb;
      --shadow: 0 10px 30px rgba(24, 35, 75, .12);
      --popover: #fff;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      line-height:1.45; letter-spacing:.2px;
    }
    .container{max-width:1200px; margin:0 auto; padding:24px;}
    header{background:linear-gradient(135deg, var(--panel-2), transparent 60%), linear-gradient(45deg, rgba(48,94,255,.15), rgba(0,212,255,.05)); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);}
    .hdr-inner{display:flex; align-items:center; justify-content:space-between; gap:16px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{width:40px; height:40px; border-radius:12px; background:radial-gradient(120px 50px at 30% 30%, var(--accent), transparent 70%), radial-gradient(120px 50px at 70% 70%, var(--accent-2), transparent 70%), linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0)); box-shadow:var(--shadow);}
    .title{font-weight:800; font-size:20px; letter-spacing:0.5px}
    .badge{font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted);}
    .toolbar{display:flex; gap:10px; align-items:center}
    .switch{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
    .switch input{appearance:none; width:44px; height:26px; background:var(--panel); border:1px solid var(--border); border-radius:999px; position:relative; outline:none; cursor:pointer; transition:.2s}
    .switch input:checked{background:linear-gradient(45deg, var(--accent), var(--accent-2))}
    .switch input::after{content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:.2s}
    .switch input:checked::after{left:21px}

    main{padding-top:18px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}

    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
    .panel h2{margin:0; padding:14px 16px; font-size:14px; letter-spacing:.5px; text-transform:uppercase; color:var(--muted); border-bottom:1px solid var(--border)}
    .panel .body{padding:16px}

    textarea{
      width:100%; min-height:260px; resize:vertical; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); color:var(--text);
      font: 14px/1.5 "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      padding:14px; outline:none; box-shadow: inset 0 0 0 999px rgba(0,0,0,0);
    }
    textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(122,162,255,.25)}

    .controls{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .controls .group{display:flex; align-items:center; gap:8px; background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:8px 10px}
    .controls .group label{font-size:12px; color:var(--muted)}
    input[type="number"], input[type="text"], select{background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text); padding:6px 8px; outline:none}
    input[type="color"]{appearance:none; border:none; background:transparent; width:28px; height:28px}
    .btn{
      appearance:none; border:none; background:linear-gradient(45deg, var(--accent), var(--accent-2)); color:white; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:var(--shadow);
      transition:transform .08s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid var(--border)}
    .btn.warn{background:linear-gradient(45deg, var(--warning), #ffda8a)}
    .btn.good{background:linear-gradient(45deg, var(--success), #9ef7a7)}
    .btn.bad{background:linear-gradient(45deg, var(--danger), #ffb1b7)}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}

    .templates-toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; position:relative;}
    .templates{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .template{font-size:12px; padding:6px 8px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); cursor:pointer}

    .dropdown{position:absolute; right:0; top:100%; margin-top:8px; width:290px; background:var(--popover); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px; z-index:20;}
    .dropdown h3{margin:0 0 8px 0; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px}
    .dropdown .row{display:flex; gap:6px; margin:8px 0 6px 0}
    .dropdown .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel-2); cursor:pointer}
    .dropdown .catlist{display:grid; grid-template-columns: 1fr 1fr; gap:8px; max-height:260px; overflow:auto; padding-right:2px}
    .dropdown label{display:flex; align-items:center; gap:8px; font-size:13px}
    .dropdown small{color:var(--muted); display:block; margin-top:6px}

    .preview-wrap{padding:16px}
    .canvas-wrap{display:flex; align-items:center; justify-content:center; min-height:260px; background: repeating-conic-gradient(#0000 0 25%, rgba(127,127,127,.1) 0 50%) 50% / 16px 16px; border:1px dashed var(--border); border-radius:12px}
    .preview{max-width:100%; height:auto; display:block}
    .meta{display:flex; gap:12px; flex-wrap:wrap; color:var(--muted); font-size:13px; margin-top:8px}

    details.instructions{margin-top:14px; background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:12px 14px}
    details.instructions summary{cursor:pointer; font-weight:600}
    details.instructions p{color:var(--muted); margin:.4em 0}

    .status{margin-top:10px; font-size:13px; white-space:pre-wrap}
    .status.ok{color:var(--success)}
    .status.err{color:var(--danger)}

    .history{display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:12px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column}
    .card img{width:100%; height:160px; object-fit:contain; background: #0a0a0a10}
    .card .info{padding:10px}
    .card .info small{color:var(--muted)}
    .card .actions{display:flex; gap:8px; padding:10px}

    /*
      AI solver styles. The new AI section appears below the LaTeX preview. It
      preserves the existing aesthetic by reusing color variables and spacing.
      The solution container wraps long text and allows scrolling when
      necessary without breaking the overall page layout. The button reuses
      the existing .btn style.
    */
    .ai-section{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .ai-solution{
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      color:var(--text);
      font-size:14px;
      line-height:1.4;
      white-space:pre-wrap;
      max-height:300px;
      overflow-y:auto;
    }

    footer{margin-top:32px; padding:18px 0; color:var(--muted); border-top:1px solid var(--border)}
    code.inline{font-family:"JetBrains Mono", monospace; background:rgba(122,162,255,.12); padding:.2em .45em; border-radius:6px}

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .dropdown{right:auto; left:0;}
    }
  </style>

  <!-- MathJax (TeX → SVG). -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'],['\\(','\\)']],
        displayMath: [['$$','$$'],['\\[','\\]']],
        packages: {'[+]': ['base','ams']},  // ams for aligned/flalign/etc.
        maxBuffer: 10000
      },
      svg: { fontCache: 'none' },
      options: { enableMenu: false }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body class="light" id="body">
  <header>
    <div class="container hdr-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">LatRen</div>
          <div class="badge">Standalone LaTeX → Image Toolkit</div>
        </div>
      </div>
      <div class="toolbar">
        <label class="switch" title="Toggle theme">
          <input id="themeToggle" type="checkbox" />
          <span>Dark mode</span>
        </label>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="panel" aria-labelledby="editor-title">
        <h2 id="editor-title">Editor</h2>
        <div class="body">
          <div class="row">
            <div>
              <label for="latex" class="badge">LaTeX Input</label>
              <textarea id="latex" spellcheck="false" placeholder="Type LaTeX here...">\[
\text{Welcome to LatRen! Render: Ctrl/⌘+Enter · PNG: Ctrl/⌘+S · Copy: Ctrl/⌘+K}
\]
\[\text{Separate formulas with a blank line for Batch → ZIP. Use single backslashes.}\]
</textarea>
            </div>
          </div>

          <div class="templates-toolbar">
            <div class="badge">Math Keys</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn secondary" id="templateFilterBtn" aria-haspopup="true" aria-expanded="false" type="button">Categories ▾</button>
              <span id="catSummary" style="font-size:12px; color:var(--muted)"></span>
            </div>
            <div class="dropdown" id="templateDropdown" hidden>
              <h3>Show categories</h3>
              <div class="row">
                <button class="pill" id="selectAll" type="button">All</button>
                <button class="pill" id="selectNone" type="button">None</button>
                <button class="pill" id="selectIB" type="button">IB Core</button>
              </div>
              <div class="catlist" id="catList"></div>
              <small>Selections persist locally.</small>
            </div>
          </div>

          <div class="templates" id="templates">
            <!-- Basics -->
            <button class="template" data-cat="basics" data-snippet="x^2">x²</button>
            <button class="template" data-cat="basics" data-snippet="x^{n}">xⁿ</button>
            <button class="template" data-cat="basics" data-snippet="x_{i}">xᵢ</button>
            <button class="template" data-cat="basics" data-snippet="\frac{a}{b}">a⁄b</button>
            <button class="template" data-cat="basics" data-snippet="\sqrt{x}">√x</button>
            <button class="template" data-cat="basics" data-snippet="\sqrt[n]{x}">ⁿ√x</button>
            <button class="template" data-cat="basics" data-snippet="\lvert x \rvert">|x|</button>
            <button class="template" data-cat="basics" data-snippet="\lVert \mathbf{x} \rVert">‖x‖</button>
            <button class="template" data-cat="basics" data-snippet="\lfloor x \rfloor">⌊x⌋</button>
            <button class="template" data-cat="basics" data-snippet="\lceil x \rceil">⌈x⌉</button>
            <button class="template" data-cat="basics" data-snippet="\overline{AB}">AB̅</button>
            <button class="template" data-cat="basics" data-snippet="\vec{v}">v⃗</button>
            <button class="template" data-cat="basics" data-snippet="\hat{y}">ŷ</button>
            <button class="template" data-cat="basics" data-snippet="\bar{x}">x̄</button>
            <button class="template" data-cat="basics" data-snippet="\dot{x}">ẋ</button>
            <button class="template" data-cat="basics" data-snippet="\ddot{x}">ẍ</button>
            <button class="template" data-cat="basics" data-snippet="f(x)=">f(x)=</button>
            <button class="template" data-cat="basics" data-snippet="( \, )">( )</button>
            <button class="template" data-cat="basics" data-snippet="[ \]">[ ]</button>
            <button class="template" data-cat="basics" data-snippet="\{ \, \}">{ }</button>

            <!-- Constants & sets -->
            <button class="template" data-cat="constants" data-snippet="\pi">π</button>
            <button class="template" data-cat="constants" data-snippet="e^{x}">eˣ</button>
            <button class="template" data-cat="constants" data-snippet="\infty">∞</button>
            <button class="template" data-cat="constants" data-snippet="\mathbb{R}">ℝ</button>
            <button class="template" data-cat="constants" data-snippet="\mathbb{Z}">ℤ</button>
            <button class="template" data-cat="constants" data-snippet="\mathbb{N}">ℕ</button>
            <button class="template" data-cat="constants" data-snippet="\mathbb{Q}">ℚ</button>
            <button class="template" data-cat="constants" data-snippet="\mathbb{C}">ℂ</button>

            <!-- Greek -->
            <button class="template" data-cat="greek" data-snippet="\alpha">α</button>
            <button class="template" data-cat="greek" data-snippet="\beta">β</button>
            <button class="template" data-cat="greek" data-snippet="\gamma">γ</button>
            <button class="template" data-cat="greek" data-snippet="\Delta">Δ</button>
            <button class="template" data-cat="greek" data-snippet="\theta">θ</button>
            <button class="template" data-cat="greek" data-snippet="\lambda">λ</button>
            <button class="template" data-cat="greek" data-snippet="\mu">μ</button>
            <button class="template" data-cat="greek" data-snippet="\sigma">σ</button>
            <button class="template" data-cat="greek" data-snippet="\Sigma">Σ</button>
            <button class="template" data-cat="greek" data-snippet="\phi">φ</button>
            <button class="template" data-cat="greek" data-snippet="\omega">ω</button>
            <button class="template" data-cat="greek" data-snippet="\Omega">Ω</button>
            <button class="template" data-cat="greek" data-snippet="\partial">∂</button>

            <!-- Trig / exp / logs -->
            <button class="template" data-cat="trig" data-snippet="\sin(x)">sin</button>
            <button class="template" data-cat="trig" data-snippet="\cos(x)">cos</button>
            <button class="template" data-cat="trig" data-snippet="\tan(x)">tan</button>
            <button class="template" data-cat="trig" data-snippet="\csc(x)">csc</button>
            <button class="template" data-cat="trig" data-snippet="\sec(x)">sec</button>
            <button class="template" data-cat="trig" data-snippet="\cot(x)">cot</button>
            <button class="template" data-cat="trig" data-snippet="\arcsin(x)">sin⁻¹</button>
            <button class="template" data-cat="trig" data-snippet="\arccos(x)">cos⁻¹</button>
            <button class="template" data-cat="trig" data-snippet="\arctan(x)">tan⁻¹</button>
            <button class="template" data-cat="trig" data-snippet="\sinh(x)">sinh</button>
            <button class="template" data-cat="trig" data-snippet="\cosh(x)">cosh</button>
            <button class="template" data-cat="trig" data-snippet="\tanh(x)">tanh</button>
            <button class="template" data-cat="trig" data-snippet="\ln(x)">ln</button>
            <button class="template" data-cat="trig" data-snippet="\log(x)">log</button>
            <button class="template" data-cat="trig" data-snippet="\log_{b}(x)">log₍ᵦ₎</button>

            <!-- Calculus -->
            <button class="template" data-cat="calculus" data-snippet="\frac{d}{dx} f(x)">d/dx</button>
            <button class="template" data-cat="calculus" data-snippet="\frac{d^{n}}{dx^{n}} f(x)">dⁿ/dxⁿ</button>
            <button class="template" data-cat="calculus" data-snippet="\frac{\partial f}{\partial x}">∂/∂x</button>
            <button class="template" data-cat="calculus" data-snippet="\nabla f">∇f</button>
            <button class="template" data-cat="calculus" data-snippet="\int f(x)\,dx">∫</button>
            <button class="template" data-cat="calculus" data-snippet="\int_{a}^{b} f(x)\,dx">∫ₐᵇ</button>
            <button class="template" data-cat="calculus" data-snippet="\iint_{D} f(x,y)\,dA">∬</button>
            <button class="template" data-cat="calculus" data-snippet="\iiint_{V} f(x,y,z)\,dV">∭</button>
            <button class="template" data-cat="calculus" data-snippet="\lim_{x\to a} f(x)">lim</button>
            <button class="template" data-cat="calculus" data-snippet="\sum_{k=1}^{n} a_k">∑</button>
            <button class="template" data-cat="calculus" data-snippet="\prod_{k=1}^{n} a_k">∏</button>
            <button class="template" data-cat="calculus" data-snippet="\int_{-\infty}^{\infty} e^{-x^2}\,dx=\sqrt{\pi}">∫e^{-x²}</button>

            <!-- Algebra / relations -->
            <button class="template" data-cat="algebra" data-snippet="\cdot">·</button>
            <button class="template" data-cat="algebra" data-snippet="\times">×</button>
            <button class="template" data-cat="algebra" data-snippet="\div">÷</button>
            <button class="template" data-cat="algebra" data-snippet="\pm">±</button>
            <button class="template" data-cat="algebra" data-snippet="\mp">∓</button>
            <button class="template" data-cat="algebra" data-snippet="\le">≤</button>
            <button class="template" data-cat="algebra" data-snippet="\ge">≥</button>
            <button class="template" data-cat="algebra" data-snippet="\neq">≠</button>
            <button class="template" data-cat="algebra" data-snippet="\approx">≈</button>
            <button class="template" data-cat="algebra" data-snippet="\equiv">≡</button>
            <button class="template" data-cat="algebra" data-snippet="\propto">∝</button>
            <button class="template" data-cat="algebra" data-snippet="\sim">∼</button>
            <button class="template" data-cat="algebra" data-snippet="\in">∈</button>
            <button class="template" data-cat="algebra" data-snippet="\notin">∉</button>
            <button class="template" data-cat="algebra" data-snippet="\subseteq">⊆</button>
            <button class="template" data-cat="algebra" data-snippet="\supseteq">⊇</button>
            <button class="template" data-cat="algebra" data-snippet="\cup">∪</button>
            <button class="template" data-cat="algebra" data-snippet="\cap">∩</button>
            <button class="template" data-cat="algebra" data-snippet="\setminus">∖</button>
            <button class="template" data-cat="algebra" data-snippet="\{\;x\in\mathbb{R}\mid\;\}">{x|}</button>
            <button class="template" data-cat="algebra" data-snippet="\binom{n}{k}">nCk</button>
            <button class="template" data-cat="algebra" data-snippet="\therefore">∴</button>

            <!-- Arrows -->
            <button class="template" data-cat="arrows" data-snippet="\to">→</button>
            <button class="template" data-cat="arrows" data-snippet="\Rightarrow">⇒</button>
            <button class="template" data-cat="arrows" data-snippet="\leftrightarrow">↔</button>
            <button class="template" data-cat="arrows" data-snippet="\mapsto">↦</button>

            <!-- Matrices / vectors / cases -->
            <button class="template" data-cat="matrices" data-snippet="\begin{bmatrix} a & b \\ c & d \end{bmatrix}">2×2</button>
            <button class="template" data-cat="matrices" data-snippet="\begin{pmatrix} a \\ b \\ c \end{pmatrix}">col</button>
            <button class="template" data-cat="matrices" data-snippet="\det\!\begin{bmatrix} a & b \\ c & d \end{bmatrix}">|A|</button>
            <button class="template" data-cat="matrices" data-snippet="A^{\mathsf{T}}">ᵀ</button>
            <button class="template" data-cat="matrices" data-snippet="\begin{cases} ax+b,& x\ge 0 \\ -x,& x<0 \end{cases}">⎧⎫</button>

            <!-- Geometry -->
            <button class="template" data-cat="geometry" data-snippet="\angle ABC">∠</button>
            <button class="template" data-cat="geometry" data-snippet="^\circ">°</button>
            <button class="template" data-cat="geometry" data-snippet="\triangle ABC">△</button>
            <button class="template" data-cat="geometry" data-snippet="\overrightarrow{AB}">AB⃗</button>

            <!-- Probability / stats -->
            <button class="template" data-cat="probability" data-snippet="\mathbb{E}[X]">𝔼[·]</button>
            <button class="template" data-cat="probability" data-snippet="\mathrm{Var}(X)">Var</button>
            <button class="template" data-cat="probability" data-snippet="P(A\mid B)">P(|)</button>
            <button class="template" data-cat="probability" data-snippet="P(A\cap B)">P(∩)</button>
            <button class="template" data-cat="probability" data-snippet="P(A\cup B)">P(∪)</button>

            <!-- Complex -->
            <button class="template" data-cat="complex" data-snippet="\Re(z)">Re</button>
            <button class="template" data-cat="complex" data-snippet="\Im(z)">Im</button>
            <button class="template" data-cat="complex" data-snippet="\lvert z \rvert">|z|</button>
            <button class="template" data-cat="complex" data-snippet="\arg(z)">arg</button>

            <!-- Series / sequences -->
            <button class="template" data-cat="series" data-snippet="\sum_{k=0}^{n} r^{k}=\frac{1-r^{n+1}}{1-r},\; r\ne1">Geom Σ</button>
            <button class="template" data-cat="series" data-snippet="a_{n}\to L">aₙ→L</button>
            <button class="template" data-cat="series" data-snippet="\frac{n}{2}\left(2a_{1}+(n-1)d\right)=\sum_{k=1}^{n}\left(a_{1}+(k-1)d\right)">Arith Σ</button>

            <!-- Dots / spacing -->
            <button class="template" data-cat="dots" data-snippet="\cdots">⋯</button>
            <button class="template" data-cat="dots" data-snippet="\ldots">…</button>
          </div>

          <div class="controls" aria-label="Render and export controls">
            <button class="btn" id="renderBtn" type="button">Render (Ctrl/⌘+Enter)</button>
            <button class="btn secondary" id="liveToggle" aria-pressed="false" type="button">Live: Off</button>
            <button class="btn good" id="downloadPNGBtn" type="button">Download PNG (Ctrl/⌘+S)</button>
            <button class="btn secondary" id="downloadSVGBtn" type="button">Download SVG</button>
            <button class="btn secondary" id="copyPNGBtn" type="button">Copy PNG</button>
            <button class="btn secondary" id="copySVGBtn" type="button">Copy SVG</button>
            <button class="btn secondary" id="shareBtn" type="button">Share link</button>
            <button class="btn warn" id="saveHistoryBtn" type="button">Save to History</button>
            <button class="btn bad" id="clearBtn" type="button">Clear</button>
            <button class="btn warn" id="batchZipBtn" type="button" title="Split by blank lines → render each → ZIP PNG+SVG">Batch → ZIP</button>
          </div>

          <div class="controls" aria-label="Output options">
            <div class="group"><label for="scale">Scale</label><input id="scale" type="number" min="0.25" step="0.25" value="2" />×</div>
            <div class="group"><label for="padding">Padding</label><input id="padding" type="number" min="0" step="2" value="20" /> px</div>
            <div class="group"><label for="bg">Background</label><input id="bg" type="color" value="#ffffff" title="Background color"/><label><input id="transparent" type="checkbox" /> transparent</label></div>
            </div>

          <div class="status" id="status"></div>

          <details class="instructions">
            <summary>How to use</summary>
            <p>Type math LaTeX (e.g., environments like <code class="inline">aligned</code>, <code class="inline">cases</code>, <code class="inline">bmatrix</code>). Use <code class="inline">$$...$$</code> or block environments — full documents with <code class="inline">\documentclass</code> are <em>not</em> supported.</p>
            <p>Click <strong>Render</strong>, then <strong>Download PNG/SVG</strong>. Adjust <em>scale</em> for resolution and <em>padding</em> for margins. Toggle <em>transparent</em> background for overlays. Use <strong>Share link</strong> to encode your formula in the URL.</p>
            <p>Shortcuts: <code class="inline">Ctrl/⌘+Enter</code> render · <code class="inline">Ctrl/⌘+S</code> download PNG · <code class="inline">Ctrl/⌘+K</code> copy PNG</p>
            <p><strong>Batch → ZIP:</strong> Separate formulas with a blank line. Each block renders to both SVG and PNG inside a ZIP (plus manifest and any errors).</p>
          </details>
        </div>
      </section>

      <section class="panel" aria-labelledby="preview-title">
        <h2 id="preview-title">Preview</h2>
        <div class="preview-wrap">
          <div class="canvas-wrap">
            <img id="preview" alt="Rendered LaTeX preview" class="preview" />
          </div>
          <div class="meta">
            <div id="meta-size">—</div>
            <div id="meta-type">PNG</div>
            <div id="meta-bg">BG: #FFFFFF</div>
          </div>

          <!-- AI solver section: displays a button to trigger the AI and a
               container for the resulting explanation. This stays within
               the preview panel to avoid altering the overall layout. -->
          <div class="ai-section" id="aiSection">
            <button class="btn" id="solveBtn" type="button">Solve</button>
            <div id="aiSolution" class="ai-solution"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="panel" style="margin-top:18px" aria-labelledby="history-title">
      <h2 id="history-title">History (local)</h2>
      <div class="body">
        <div class="history" id="history"></div>
      </div>
    </section>

    <footer>
      <div>
        Built with MathJax (TeX→SVG), JSZip, and localStorage. Fully standalone single-file app.
      </div>
    </footer>
  </main>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const els = {
      body: document.getElementById('body'),
      latex: $('#latex'),
      renderBtn: $('#renderBtn'),
      liveToggle: $('#liveToggle'),
      preview: $('#preview'),
      status: $('#status'),
      metaSize: $('#meta-size'),
      metaType: $('#meta-type'),
      metaBg: $('#meta-bg'),
      scale: $('#scale'),
      padding: $('#padding'),
      bg: $('#bg'),
      transparent: $('#transparent'),
      downloadPNGBtn: $('#downloadPNGBtn'),
      downloadSVGBtn: $('#downloadSVGBtn'),
      copyPNGBtn: $('#copyPNGBtn'),
      copySVGBtn: $('#copySVGBtn'),
      clearBtn: $('#clearBtn'),
      shareBtn: $('#shareBtn'),
      saveHistoryBtn: $('#saveHistoryBtn'),
      history: $('#history'),
      themeToggle: $('#themeToggle'),
      templates: $('#templates'),
      templateFilterBtn: $('#templateFilterBtn'),
      templateDropdown: $('#templateDropdown'),
      catList: $('#catList'),
      catSummary: $('#catSummary'),
      selectAll: $('#selectAll'),
      selectNone: $('#selectNone'),
      selectIB: $('#selectIB'),
      batchZipBtn: $('#batchZipBtn'),
      // AI solver elements
      solveBtn: $('#solveBtn'),
      aiSolution: $('#aiSolution'),
    };

    const state = {
      svgText: '',
      pngDataURL: '',
      pngBlob: null,
      live: false,
      dark: false,
      cats: new Set()
    };

    // --- Category filtering ---
    const CATS = [
      ['basics','Basics'],
      ['constants','Constants & sets'],
      ['greek','Greek'],
      ['trig','Trig / exp / logs'],
      ['calculus','Calculus'],
      ['algebra','Algebra / relations'],
      ['arrows','Arrows'],
      ['matrices','Matrices / vectors / cases'],
      ['geometry','Geometry'],
      ['probability','Probability / stats'],
      ['complex','Complex'],
      ['series','Series / sequences'],
      ['dots','Dots / spacing']];

    const CATS_KEY = 'latren-template-cats-v1';

    function loadCats(){
      try{
        const arr = JSON.parse(localStorage.getItem(CATS_KEY) || 'null');
        if(Array.isArray(arr) && arr.length){ state.cats = new Set(arr); }
        else { state.cats = new Set(CATS.map(([k])=>k)); }
      }catch{ state.cats = new Set(CATS.map(([k])=>k)); }
    }
    function saveCats(){ localStorage.setItem(CATS_KEY, JSON.stringify([...state.cats])); }
    function applyCategoryFilter(){
      const allBtns = $$('.template');
      allBtns.forEach(btn => {
        const cat = btn.getAttribute('data-cat') || '';
        btn.style.display = state.cats.has(cat) ? '' : 'none';
      });
      const total = allBtns.length;
      const shown = allBtns.filter(b => b.style.display !== 'none').length;
      els.catSummary.textContent = `${shown}/${total} keys visible`;
    }
    function buildCatUI(){
      els.catList.innerHTML = '';
      CATS.forEach(([key,label]) => {
        const id = 'cat-' + key;
        const wrap = document.createElement('label');
        wrap.setAttribute('for', id);
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.id = id; cb.checked = state.cats.has(key);
        cb.dataset.key = key;
        cb.addEventListener('change', () => {
          if(cb.checked) state.cats.add(key); else state.cats.delete(key);
          saveCats(); applyCategoryFilter();
        });
        const span = document.createElement('span'); span.textContent = label;
        wrap.appendChild(cb); wrap.appendChild(span);
        els.catList.appendChild(wrap);
      });
    }
    function openDropdown(){
      els.templateDropdown.hidden = false;
      els.templateFilterBtn.setAttribute('aria-expanded', 'true');
      buildCatUI();
      document.addEventListener('click', onDocClick, { once: true });
      document.addEventListener('keydown', onEsc, { once: true });
    }
    function closeDropdown(){
      els.templateDropdown.hidden = true;
      els.templateFilterBtn.setAttribute('aria-expanded', 'false');
    }
    function onDocClick(e){
      if(!els.templateDropdown.contains(e.target) && e.target !== els.templateFilterBtn){
        closeDropdown();
      } else { document.addEventListener('click', onDocClick, { once: true }); }
    }
    function onEsc(e){
      if(e.key === 'Escape') closeDropdown();
      else document.addEventListener('keydown', onEsc, { once: true });
    }

    els.templateFilterBtn.addEventListener('click', ()=>{
      const opened = els.templateDropdown.hidden === false;
      if(opened) closeDropdown(); else openDropdown();
    });
    els.selectAll.addEventListener('click', ()=>{ state.cats = new Set(CATS.map(([k])=>k)); saveCats(); buildCatUI(); applyCategoryFilter(); });
    els.selectNone.addEventListener('click', ()=>{ state.cats = new Set(); saveCats(); buildCatUI(); applyCategoryFilter(); });
    els.selectIB.addEventListener('click', ()=>{ state.cats = new Set(['basics','greek','calculus','algebra','matrices','probability','series']); saveCats(); buildCatUI(); applyCategoryFilter(); });

    // Theme
    els.themeToggle.addEventListener('change', () => {
      state.dark = els.themeToggle.checked;
      document.body.classList.toggle('light', !state.dark);
      document.body.classList.toggle('dark', state.dark);
    });

    // Template insertion: normalize to single backslashes
    $$('.template').forEach(btn => btn.addEventListener('click', () => {
      const raw = btn.getAttribute('data-snippet') || '';
      const single = raw.replace(/\\\\/g, '\\');
      insertAtCursor(els.latex, single);
      if(state.live) render();
    }));

    function insertAtCursor(textarea, text){
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      const value = textarea.value;
      textarea.value = value.slice(0,start) + text + value.slice(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
    }

    // Live toggle
    els.liveToggle.addEventListener('click', () => {
      state.live = !state.live;
      els.liveToggle.setAttribute('aria-pressed', String(state.live));
      els.liveToggle.textContent = `Live: ${state.live ? 'On' : 'Off'}`;
      if(state.live) render();
    });

    // Status helpers
    function setStatus(msg, cls){ els.status.textContent = msg; els.status.className = 'status ' + (cls || ''); }
    function clearStatus(){ els.status.textContent = ''; els.status.className = 'status'; }

    // Render: TeX -> SVG -> PNG
    async function render(){
      clearStatus();
      const tex = els.latex.value.trim();
      if(!tex){ setStatus('Enter some LaTeX to render.', 'err'); return; }

      if(window.MathJax?.startup?.promise){ await MathJax.startup.promise; }

      let svgNode;
      try {
        svgNode = await MathJax.tex2svgPromise(tex, {display:true});
      } catch (err) {
        console.error(err);
        setStatus('LaTeX parse error. Tip: use \\[...\\] or environments; wrap text with \\text{...}', 'err');
        return;
      }

      const svg = svgNode.querySelector('svg');
      if(!svg){ setStatus('Failed to create SVG.', 'err'); return; }
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.removeAttribute('style');

      const ser = new XMLSerializer();
      let svgText = ser.serializeToString(svg);
      if(!svgText.startsWith('<?xml')) svgText = `<?xml version="1.0" encoding="UTF-8"?>\n` + svgText;
      state.svgText = svgText;

      try {
        const {dataURL, blob, canvas} = await svgToPng(svgText, readScale(), readBg(), readPadding());
        els.preview.src = dataURL;
        state.pngDataURL = dataURL;
        state.pngBlob = blob;
        els.metaSize.textContent = `${canvas.width} × ${canvas.height}px`;
        els.metaType.textContent = 'PNG';
        els.metaBg.textContent = `BG: ${els.transparent.checked ? 'transparent' : els.bg.value.toUpperCase()}`;
      } catch (err) {
        console.error(err);
        setStatus('Render error: ' + (err.message || err.toString()), 'err');
        return;
      }
      setStatus('Rendered successfully ✓', 'ok');
      saveDraft();
    }

    function readScale(){ return clamp(parseFloat(els.scale.value)||1, 0.1, 8); }
    function readPadding(){ return Math.max(0, parseInt(els.padding.value||0,10)); }
    function readBg(){ return els.transparent.checked ? 'transparent' : els.bg.value; }
    function clamp(v, mn, mx){ return Math.max(mn, Math.min(mx, v)); }

    function svgToPng(svgText, scale, bgColor, padding){
      return new Promise((resolve, reject) => {
        const img = new Image();
        const blob = new Blob([svgText], {type:'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        img.onload = () => {
          const w = Math.ceil(img.width * scale + 2*padding);
          const h = Math.ceil(img.height * scale + 2*padding);
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          if(bgColor !== 'transparent'){
            ctx.fillStyle = bgColor;
            ctx.fillRect(0,0,w,h);
          }
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, padding, padding, img.width * scale, img.height * scale);
          canvas.toBlob(b => {
            URL.revokeObjectURL(url);
            if(!b) return reject(new Error('Failed to create PNG blob'));
            resolve({blob: b, dataURL: URL.createObjectURL(b), canvas});
          }, 'image/png');
        };
        img.onerror = e => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    // Downloads & clipboard
    function download(name, blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = name; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    els.downloadPNGBtn.addEventListener('click', async () => {
      if(!state.pngBlob) await render();
      const name = suggestName('latren', 'png');
      download(name, state.pngBlob);
    });

    els.downloadSVGBtn.addEventListener('click', () => {
      if(!state.svgText){ setStatus('Nothing to download. Render first.', 'err'); return; }
      const blob = new Blob([state.svgText], {type:'image/svg+xml'});
      download(suggestName('latren','svg'), blob);
    });

    els.copyPNGBtn.addEventListener('click', async () => {
      try{
        if(!state.pngBlob) await render();
        await navigator.clipboard.write([ new ClipboardItem({ 'image/png': state.pngBlob }) ]);
        setStatus('PNG copied to clipboard ✓', 'ok');
      }catch(err){ setStatus('Clipboard not available: ' + err, 'err'); }
    });

    els.copySVGBtn.addEventListener('click', async () => {
      try{
        if(!state.svgText) await render();
        const type = 'image/svg+xml';
        const blob = new Blob([state.svgText], {type});
        await navigator.clipboard.write([ new ClipboardItem({ [type]: blob }) ]);
        setStatus('SVG copied to clipboard ✓', 'ok');
      }catch(err){ setStatus('Clipboard not available: ' + err, 'err'); }
    });

    // Share link
    els.shareBtn.addEventListener('click', () => {
      const url = buildShareUrl();
      navigator.clipboard.writeText(url).then(() => setStatus('Sharable link copied ✓', 'ok'));
      history.replaceState(null, '', url);
    });

    function buildShareUrl(){
      const o = new URL(location.href);
      const params = new URLSearchParams();
      params.set('q', b64enc(els.latex.value));
      params.set('s', String(els.scale.value));
      params.set('p', String(els.padding.value));
      params.set('t', els.transparent.checked ? '1' : '0');
      return `${o.origin}${o.pathname}#${params.toString()}`;
    }
    function parseShareUrl(){
      if(!location.hash) return;
      const qs = location.hash.slice(1);
      const params = new URLSearchParams(qs);
      if(params.has('q')){ try{ els.latex.value = b64dec(params.get('q')||''); }catch{} }
      if(params.has('s')) els.scale.value = params.get('s');
      if(params.has('p')) els.padding.value = params.get('p');
      if(params.has('t')) els.transparent.checked = params.get('t')==='1';
    }
    function b64enc(str){ return btoa(unescape(encodeURIComponent(str))); }
    function b64dec(str){ return decodeURIComponent(escape(atob(str))); }
    function suggestName(base, ext){ const t = new Date().toISOString().replace(/[:.]/g,'-'); return `${base}-${t}.${ext}`; }

    // History (localStorage)
    const HISTORY_KEY = 'latren-history-v1';
    function loadHistory(){ try{ const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); return Array.isArray(arr) ? arr : []; }catch{ return []; } }
    function saveHistoryCard(item){
      const card = document.createElement('div');
      card.className = 'card';
      const img = document.createElement('img'); img.src = item.pngURL; img.alt = 'Formula preview';
      const info = document.createElement('div'); info.className='info';
      const small = document.createElement('small'); small.textContent = new Date(item.time).toLocaleString(); info.appendChild(small);
      const actions = document.createElement('div'); actions.className='actions';
      const btnUse = document.createElement('button'); btnUse.className='btn secondary'; btnUse.textContent='Load';
      const btnDL = document.createElement('button'); btnDL.className='btn'; btnDL.textContent='PNG';
      btnUse.onclick = () => { els.latex.value = item.latex; if(state.live) render(); window.scrollTo({top:0, behavior:'smooth'}); };
      btnDL.onclick = () => fetch(item.pngURL).then(r=>r.blob()).then(b=>download(suggestName('latren','png'), b));
      actions.appendChild(btnUse); actions.appendChild(btnDL);
      card.appendChild(img); card.appendChild(info); card.appendChild(actions);
      els.history.prepend(card);
    }
    function refreshHistory(){ els.history.innerHTML = ''; loadHistory().forEach(saveHistoryCard); }
    function addToHistory(){
      if(!state.pngDataURL) { setStatus('Render first to save history.', 'err'); return; }
      const items = loadHistory();
      const entry = { latex: els.latex.value, pngURL: state.pngDataURL, time: Date.now() };
      items.unshift(entry); while(items.length > 24) items.pop();
      localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
      saveHistoryCard(entry);
      setStatus('Saved to history ✓', 'ok');
    }
    els.saveHistoryBtn.addEventListener('click', addToHistory);

    // Draft
    const DRAFT_KEY = 'latren-draft-v1';
    function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify({ latex: els.latex.value, scale: els.scale.value, padding: els.padding.value, bg: els.bg.value, transparent: els.transparent.checked })); }
    function loadDraft(){ try{ const d = JSON.parse(localStorage.getItem(DRAFT_KEY)||'null'); if(d){ els.latex.value = d.latex||els.latex.value; els.scale.value = d.scale||els.scale.value; els.padding.value = d.padding||els.padding.value; els.bg.value = d.bg||els.bg.value; els.transparent.checked = !!d.transparent; } }catch{} }

    // Clear
    els.clearBtn.addEventListener('click', () => {
      els.latex.value=''; state.svgText=''; state.pngDataURL=''; state.pngBlob=null; els.preview.removeAttribute('src'); els.metaSize.textContent='—'; clearStatus(); saveDraft();
    });

    ['input','change'].forEach(ev => {
      [els.latex, els.scale, els.padding, els.bg, els.transparent].forEach(el => {
        el.addEventListener(ev, () => { saveDraft(); if(state.live) render(); });
      });
    });

    els.renderBtn.addEventListener('click', render);

    document.addEventListener('keydown', (e) => {
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); render(); }
      if((e.ctrlKey||e.metaKey) && (e.key==='s' || e.key==='S')){ e.preventDefault(); els.downloadPNGBtn.click(); }
      if((e.ctrlKey||e.metaKey) && (e.key==='k' || e.key==='K')){ e.preventDefault(); els.copyPNGBtn.click(); }
    });

    // --- Batch → ZIP ---
    els.batchZipBtn.addEventListener('click', batchToZip);

    function splitIntoJobs(text){
      // Split by two or more newlines; trim each block; filter empty.
      return text.split(/\r?\n\r?\n+/).map(s => s.trim()).filter(Boolean);
    }

    
    // New splitter: split by single line breaks, but keep multi-line TeX blocks intact.
    function splitIntoJobsLines(text){
      const lines = (text || '').replace(/\r\n/g, '\n').split('\n');
      const jobs = [];
      let i = 0;

      const countDollars = (s)=> (s.match(/\$\$/g) || []).length;

      while (i < lines.length) {
        let line = (lines[i] || '').trim();
        i++;
        if (!line) continue;

        // \[ ... \]
        if (line.includes('\\[') && !line.includes('\\]')) {
          let block = line;
          while (i < lines.length) {
            block += '\n' + lines[i];
            if ((lines[i] || '').includes('\\]')) { i++; break; }
            i++;
          }
          jobs.push(block.trim());
          continue;
        }

        // $$ ... $$ (balance odd $$ counts)
        if (countDollars(line) % 2 === 1) {
          let block = line;
          while (i < lines.length) {
            block += '\n' + lines[i];
            if (countDollars(lines[i] || '') % 2 === 1) { i++; break; }
            i++;
          }
          jobs.push(block.trim());
          continue;
        }

        // \begin{env} ... \end{env}
        const m = line.match(/\\begin\{([^}]+)\}/);
        if (m) {
          const env = m[1];
          if (!line.includes(`\\end{${env}}`)) {
            let block = line;
            while (i < lines.length) {
              block += '\n' + lines[i];
              if ((lines[i] || '').includes(`\\end{${env}}`)) { i++; break; }
              i++;
            }
            jobs.push(block.trim());
            continue;
          }
        }

        jobs.push(line);
      }
      return jobs;
    }

async function batchToZip(){
      clearStatus();
      const raw = els.latex.value || '';
      const blocks = splitIntoJobsLines(raw);
      if(blocks.length === 0){ setStatus('Nothing to batch: separate formulas with a blank line.', 'err'); return; }

      if(window.MathJax?.startup?.promise){ await MathJax.startup.promise; }

      const zip = new JSZip();
      const fPNG = zip.folder('png');
      const fSVG = zip.folder('svg');
      const meta = [];
      const errors = [];

      const digits = String(blocks.length).length;
      const pad = n => String(n).padStart(digits, '0');
      const scale = readScale();
      const padding = readPadding();
      const bg = readBg();
      setStatus(`Batch: ${blocks.length} item(s)…`, 'ok');

      for(let i=0;i<blocks.length;i++){
        const idx = i+1, label = pad(idx);
        const tex = blocks[i];
        setStatus(`Rendering ${idx}/${blocks.length}…`, 'ok');

        try{
          const svgNode = await MathJax.tex2svgPromise(tex, {display:true});
          const svg = svgNode.querySelector('svg');
          if(!svg) throw new Error('No SVG produced');

          svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
          svg.removeAttribute('style');
          const ser = new XMLSerializer();
          let svgText = ser.serializeToString(svg);
          if(!svgText.startsWith('<?xml')) svgText = `<?xml version="1.0" encoding="UTF-8"?>\n` + svgText;

          const { blob: pngBlob } = await svgToPng(svgText, scale, bg, padding);

          fSVG.file(`${label}.svg`, svgText);
          const pngArrayBuf = await blobToArrayBuffer(pngBlob);
          fPNG.file(`${label}.png`, pngArrayBuf);

          meta.push(`${label}\tchars=${tex.length}\tscale=${scale}\tpadding=${padding}\tbg=${bg}`);
        }catch(err){
          const msg = (err && (err.message || String(err))) || 'Unknown error';
          errors.push(`Item ${label}: ${msg}\n---\n${tex}\n---\n`);
        }
      }

      zip.file('manifest.txt', meta.join('\n'));
      if(errors.length){ zip.file('errors.txt', errors.join('\n\n')); }

      setStatus('Packaging ZIP…', 'ok');
      const blob = await zip.generateAsync({type:'blob', compression: 'DEFLATE'});
      download(suggestName('latren-batch','zip'), blob);
      setStatus(`Done ✓  PNG: /png/*.png · SVG: /svg/*.svg${errors.length ? ` · ${errors.length} error(s) logged` : ''}`, 'ok');
    }

    /*
      AI solver function
      This function sends the current LaTeX problem to the OpenRouter API and
      displays the step-by-step solution in the dedicated container. It
      temporarily disables the solve button while awaiting a response and
      provides basic error handling. The API key below is provided by the
      user; do not share or log this key anywhere else.
    */
    const CEREBRAS_KEY = 'csk-mh2dky3twvpr4dymrn25t9fjwy6dkkt6543p2ttn82jc3w5y';
    async function solveWithAI(){
      const tex = els.latex.value.trim();
      if(!tex){
        els.aiSolution.textContent = 'Please enter a problem in the LaTeX input area.';
        return;
      }
      els.solveBtn.setAttribute('disabled', 'true');
      els.aiSolution.textContent = 'Solving…';
      try {
        // Compose the message instructing the model to solve step by step
        const messages = [
          { role: 'system', content: 'You are a helpful mathematics tutor. Solve the provided problem step by step, explaining your reasoning. Make the formulas big' },
          { role: 'user', content: `Solve the following problem step by step and show all work:\n\n${tex}` }
        ];
        const response = await fetch('https://api.cerebras.ai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CEREBRAS_KEY}`
          },
          body: JSON.stringify({
            model: 'llama-3.3-70b',
            messages: messages
          })
        });
        if(!response.ok){
          throw new Error(`API request failed with status ${response.status}`);
        }
        const data = await response.json();
        const content = data?.choices?.[0]?.message?.content || '';
        if(!content){
          els.aiSolution.textContent = 'No solution was returned. Please try again.';
        } else {
          els.aiSolution.textContent = content.trim();
          // Trigger MathJax to typeset any returned LaTeX
          if(window.MathJax && MathJax.typesetPromise){
            MathJax.typesetPromise([els.aiSolution]);
          }
        }
      } catch(err){
        els.aiSolution.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
      } finally {
        els.solveBtn.removeAttribute('disabled');
      }
    }

    // Attach the click handler for the AI solver button
    if(els.solveBtn){
      els.solveBtn.addEventListener('click', solveWithAI);
    }

    function blobToArrayBuffer(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsArrayBuffer(blob);
      });
    }

    // Init
    loadCats(); applyCategoryFilter(); loadDraft(); parseShareUrl(); refreshHistory();
    // Initial render (safe content uses \[...\], not flalign*)
    setTimeout(render, 60);
  })();
  </script>
</body>
</html>
